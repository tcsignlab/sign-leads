name: Sign Lead Scraper (Auto-Cleanup)

on:
  schedule:
    # Run every 96 hours (4 days) at 2 AM UTC
    - cron: '0 2 */4 * *'
  workflow_dispatch: # Allow manual triggers

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Create state-pages directory
        run: |
          echo "üìÅ Ensuring state-pages directory exists..."
          mkdir -p state-pages
          touch state-pages/.gitkeep
          ls -la state-pages/
          echo "‚úÖ Directory ready"
      
      - name: Install dependencies
        run: |
          npm install node-fetch
      
      - name: Cleanup old state pages
        run: |
          echo "üßπ Cleaning up old state pages..."
          if [ -d "state-pages" ]; then
            echo "üìÅ Found state-pages directory"
            html_count=$(ls state-pages/*.html 2>/dev/null | wc -l)
            echo "   Found $html_count HTML files"
            if [ $html_count -gt 0 ]; then
              echo "üóëÔ∏è  Deleting old HTML files..."
              rm -f state-pages/*.html
              echo "‚úÖ Deleted $html_count files"
            else
              echo "   No HTML files to delete"
            fi
            
            if [ -f "state-pages/scrape-summary.json" ]; then
              echo "üóëÔ∏è  Deleting old scrape-summary.json..."
              rm -f state-pages/scrape-summary.json
              echo "‚úÖ Deleted scrape-summary.json"
            fi
          else
            echo "üìÅ No state-pages directory yet (will be created)"
          fi
          echo "‚úÖ Cleanup complete!"
      
      - name: Run scraper
        env:
          OUTPUT_DIR: ./state-pages
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Starting scraper..."
          node scraper-backend.js
          echo ""
          echo "‚úÖ SCRAPER COMPLETED SUCCESSFULLY"
          echo "Files created: $(find state-pages -name '*.html' | wc -l)"
          echo "Moving to next step: Git configuration..."
      
      - name: Configure Git
        if: always()
        run: |
          echo "‚öôÔ∏è Configuring Git..."
          git config --global user.name "Sign Lead Bot"
          git config --global user.email "actions@github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          echo "‚úÖ Git configured"
      
      - name: Check what files were created
        if: always()
        run: |
          echo "üìä Checking scraper output..."
          echo "Working directory: $(pwd)"
          echo ""
          if [ -d "state-pages" ]; then
            echo "Files in state-pages:"
            ls -lh state-pages/ | head -20
            echo ""
            echo "üìà Total HTML files created:"
            find state-pages -name "*.html" | wc -l
            echo ""
            echo "üíæ Repository status:"
            git status --short
          else
            echo "‚ùå state-pages directory not found!"
            ls -la
            exit 1
          fi
      
      - name: Commit and push changes
        if: always()
        run: |
          echo "================================"
          echo "üöÄ STARTING GIT COMMIT & PUSH"
          echo "================================"
          
          echo ""
          echo "üîÑ Pulling latest changes..."
          git pull origin main --rebase || true
          
          echo ""
          echo "‚ûï Adding files to git..."
          git add state-pages/ next-run.json 2>/dev/null || git add state-pages/
          
          echo ""
          echo "üìù Checking what will be committed..."
          git status --short
          
          echo ""
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No changes to commit (all files already up to date)"
            echo "This might mean the scraper didn't create new files or files are identical"
            exit 0
          fi
          
          echo "üíæ Changes detected! Committing..."
          git commit -m "ü§ñ Auto-update: Sign leads $(date +'%Y-%m-%d %H:%M UTC')" || {
            echo "‚ùå Commit failed!"
            echo "Git status:"
            git status
            exit 1
          }
          
          echo ""
          echo "üì§ Pushing to GitHub (attempt 1/3)..."
          # Retry push up to 3 times if conflicts occur
          for i in {1..3}; do
            echo "Attempt $i of 3..."
            if git push origin main 2>&1; then
              echo ""
              echo "================================"
              echo "‚úÖ PUSH SUCCESSFUL ON ATTEMPT $i"
              echo "================================"
              exit 0
            else
              echo "‚ö†Ô∏è  Push failed on attempt $i"
              if [ $i -lt 3 ]; then
                echo "Pulling and retrying in 5 seconds..."
                git pull origin main --rebase || true
                sleep 5
              fi
            fi
          done
          
          echo ""
          echo "================================"
          echo "‚ùå PUSH FAILED AFTER 3 ATTEMPTS"
          echo "================================"
          echo ""
          echo "Git status:"
          git status
          echo ""
          echo "Git log (last 5 commits):"
          git log --oneline -5
          echo ""
          echo "Git remote:"
          git remote -v
          exit 1
